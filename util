import pyodbc
import csv
import configparser
import logging
from datetime import datetime
import os
import oracledb

# Import the SecureConfig class for password decryption
try:
    from lib.secure_config import SecureConfig
    HAS_SECURE_CONFIG = True
except ImportError:
    HAS_SECURE_CONFIG = False

def load_config(config_path):
    """Load database configuration from file."""
    config = configparser.ConfigParser()
    config.read(config_path)
    db_config = config['DATABASE']
    
    # Try to get encrypted password if available
    password = db_config.get('Password', '')
    if HAS_SECURE_CONFIG and 'Password_Encrypted' in db_config:
        try:
            decrypted_password = SecureConfig.decrypt_password(db_config['Password_Encrypted'])
            if decrypted_password:
                password = decrypted_password
                logging.info("Using decrypted database password")
        except Exception as e:
            logging.warning(f"Could not decrypt database password: {e}")
            logging.warning("Falling back to plain text password")
    
    return {
        'host': db_config.get('DBHost', ''),
        'port': db_config.get('Port', '1521'),
        'service': db_config.get('ServiceName', ''),
        'schema': db_config.get('SchemaName', ''),
        'user': db_config.get('Username', ''),
        'password': password
    }

def connect_oracle(cfg):
    """Connect to Oracle database using configuration."""
    dsn = oracledb.makedsn(
        cfg['host'],
        int(cfg['port']),
        service_name=cfg['service']
    )
    return oracledb.connect(
        user=cfg['user'],
        password=cfg['password'],
        dsn=dsn
    )

def execute_query_and_write_csv(conn, query, csv_path):
    """Execute query and write results to CSV file."""
    cursor = conn.cursor()
    # Split the query on ';' and remove empty statements
    statements = [stmt.strip() for stmt in query.split(';') if stmt.strip()]
    # Execute all but the last statement (setup statements)
    for stmt in statements[:-1]:
        cursor.execute(stmt)
    # Execute the last statement (the SELECT)
    cursor.execute(statements[-1])
    columns = [column[0] for column in cursor.description]
    with open(csv_path, 'w', newline='', encoding='utf-8') as csvfile:
        writer = csv.writer(csvfile)
        writer.writerow(columns)
        for row in cursor:
            writer.writerow(row)
    cursor.close()
    logging.info(f"SQL query results exported to {csv_path}")

def sql_to_csv(config_file, query_file, output_csv, execution_timestamp=None):
    """Execute SQL and export to CSV."""
    logging.info("Starting SQL to CSV process")
    try:
        # Check query file exists
        if not os.path.exists(query_file):
            logging.error(f"Query file '{query_file}' not found")
            return False

        cfg = load_config(config_file)
        with open(query_file, 'r', encoding='utf-8') as f:
            query = f.read()
        query = query.replace('<EM_schema>', cfg['schema'])
        
        conn = connect_oracle(cfg)
        execute_query_and_write_csv(conn, query, output_csv)
        conn.close()
        logging.info("SQL to CSV process completed successfully")
        return True
    except Exception as e:
        logging.error(f"Error in SQL to CSV process: {str(e)}")
        return False
