import csv
import configparser
import logging
from datetime import datetime
import os
import subprocess
import tempfile
import pyodbc  # Keep this for SQL Server connections

def load_config(config_path):
    """Load database configuration from file."""
    config = configparser.ConfigParser()
    config.read(config_path)
    db_config = config['DATABASE']
    return {
        'host': db_config['DBHost'],
        'port': db_config['Port'],
        'service': db_config['ServiceName'],
        'schema': db_config['SchemaName'],
        'user': db_config['Username'],
        'password': db_config['Password'],
        'db_type': db_config.get('DBType', 'SQLSERVER')
    }

def connect_sql_server(cfg):
    """Connect to SQL server using configuration."""
    conn_str = (
        f"DRIVER={{ODBC Driver 17 for SQL Server}};"
        f"SERVER={cfg['host']},{cfg['port']};"
        f"DATABASE={cfg['service']};"
        f"UID={cfg['user']};"
        f"PWD={cfg['password']}"
    )
    return pyodbc.connect(conn_str)

def execute_oracle_query(cfg, query, output_csv):
    """Execute Oracle query using SQL*Plus."""
    # Create a temporary SQL file with CSV output formatting
    with tempfile.NamedTemporaryFile(mode='w', delete=False, suffix='.sql') as temp_sql:
        temp_sql.write("SET ECHO OFF\n")
        temp_sql.write("SET HEADING ON\n")
        temp_sql.write("SET PAGESIZE 0\n")
        temp_sql.write("SET LINESIZE 32767\n")
        temp_sql.write("SET FEEDBACK OFF\n")
        temp_sql.write("SET COLSEP ','\n")
        temp_sql.write("SET TRIMSPOOL ON\n")
        temp_sql.write(f"SPOOL {output_csv}\n")
        temp_sql.write(f"{query};\n")
        temp_sql.write("SPOOL OFF\n")
        temp_sql.write("EXIT\n")
        temp_sql_path = temp_sql.name
    
    # Build connection string
    conn_str = f"{cfg['user']}/{cfg['password']}@{cfg['host']}:{cfg['port']}/{cfg['service']}"
    
    try:
        # Execute SQL*Plus command
        cmd = f"sqlplus -S {conn_str} @{temp_sql_path}"
        logging.info(f"Executing Oracle query using SQL*Plus")
        process = subprocess.run(cmd, shell=True, check=True, 
                               stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        
        # Check if the output CSV was created successfully
        if os.path.exists(output_csv) and os.path.getsize(output_csv) > 0:
            logging.info(f"Query results exported to {output_csv}")
            os.unlink(temp_sql_path)
            return True
        else:
            logging.error("SQL*Plus execution failed to create CSV file")
            logging.error(f"STDOUT: {process.stdout.decode('utf-8')}")
            logging.error(f"STDERR: {process.stderr.decode('utf-8')}")
            os.unlink(temp_sql_path)
            return False
    except subprocess.CalledProcessError as e:
        logging.error(f"SQL*Plus execution error: {e}")
        logging.error(f"STDOUT: {e.stdout.decode('utf-8')}")
        logging.error(f"STDERR: {e.stderr.decode('utf-8')}")
        os.unlink(temp_sql_path)
        return False
    except Exception as e:
        logging.error(f"Error in Oracle SQL execution: {str(e)}")
        os.unlink(temp_sql_path)
        return False

def sql_to_csv(config_file, query_file, output_csv, execution_timestamp=None):
    """Execute SQL and export to CSV."""
    logging.info("Starting SQL to CSV process")
    try:
        # Check query file exists
        if not os.path.exists(query_file):
            logging.error(f"Query file '{query_file}' not found")
            return False

        cfg = load_config(config_file)
        with open(query_file, 'r', encoding='utf-8') as f:
            query = f.read()
        query = query.replace('<EM_schema>', cfg['schema'])
        
        # Execute appropriate database query
        if cfg.get('db_type', '').upper() == 'ORACLE':
            return execute_oracle_query(cfg, query, output_csv)
        else:
            conn = connect_sql_server(cfg)  # Default to SQL Server
            cursor = conn.cursor()
            cursor.execute(query)
            
            columns = [column[0] for column in cursor.description]
            with open(output_csv, 'w', newline='', encoding='utf-8') as csvfile:
                writer = csv.writer(csvfile)
                writer.writerow(columns)
                for row in cursor:
                    writer.writerow(row)
            
            cursor.close()
            conn.close()
            logging.info(f"SQL Server query results exported to {output_csv}")
            return True
    except Exception as e:
        logging.error(f"Error in SQL to CSV process: {str(e)}")
        return False
